<!DOCTYPE html>
<head>
    <title>GeoJSON + Flask + MongoDB</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>
        Let's display some nice maps here!
    </h1>

<div id="controls" style="margin: 15px;">
  <form id="form1" action="#">
  	<label for="input1">Enter Address:</label>
  	<input id="input1" type="text">
  </form>
  <form id="dateform1" action="#">
  	<label for="date1">Enter Date - Optional:</label>
  	<input id="date1" type="datetime-local">
  	<input type="submit" id="time_bt">
  </form>
  <button id="clear_bt">Clear</button>
</div>

<div id="map" style="height: 80vh;"></div>

<script>

var map = L.map('map').setView([-37.8, 144.9], 13);

L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: 'Open street map'
}).addTo(map);

// Null variables that will hold our data for the user point and the parking
var userAddressLayer = null;
var parkingLayer = null;

// Create event listener for the forms
document.getElementById("dateform1").addEventListener('submit', addPoint);
document.getElementById("dateform1").addEventListener('submit', addParking);
document.getElementById("clear_bt").addEventListener('click', clearAll);

// add point function
function addPoint() {
  var userAddress = document.getElementById("input1").value;
  axios.post('http://127.0.0.1:5000/address-point', {address: userAddress})
      .then(response => {
          console.log(response.data)
          userAddressLayer = L.geoJSON(response.data, {
            onEachFeature: function (feature, layer) {
                layer.bindPopup(feature.properties.cleanAddress);
              }
          }).addTo(map);
  })
};

// add parking data function
function addParking() {
  var userAddress = document.getElementById("input1").value;
  var userTime = document.getElementById("date1").value;
  axios.post('http://127.0.0.1:5000/nearby-parking', {address: userAddress, time: userTime})
      .then(response => {
        console.log(response.data)
        parkingLayer = L.geoJSON(response.data, {
          style: style,
          onEachFeature: function (feature, layer) {
              layer.bindPopup(feature.properties.description);
            }
        }).addTo(map);
    })
};

// add color mapping function
function setColor(avail){
return avail > 0.95 ? '#008744' :
                      '#d62d20';
};

// Set style function that sets fill color property equal to parkling availability
function style(feature) {
    return {
        fillColor: setColor(feature.properties.prediction),
        fillOpacity: 0.7,
        weight: 2,
        opacity: 1,
        color: setColor(feature.properties.prediction)
    };
}

// add clearing function
function clearAll() {
  map.removeLayer(userAddressLayer);
  map.removeLayer(parkingLayer);
};

</script>

</body>
</html>
